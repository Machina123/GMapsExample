<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
    <link rel="stylesheet" href="lib/jquery.mobile-1.3.2.min.css" />
    <script src="lib/jquery-1.11.1.min.js"></script>
    <script src="lib/jquery.mobile-1.3.2.min.js"></script>
    <script src="http://maps.google.com/maps/api/js?sensor=false&language=pl"></script>
    <script src="lib/gmap3.min.js"></script>
    <title>Hello World</title>
</head>
<body>
    <div data-role="page" id="main">
        <div id="optionsPanel" data-role="panel" data-position="left" data-slide-close="true" data-display="push">
            
            <input id="Rlon" type="range" min="-180" max="180" value="0" />
            <input id="Rlat" type="range" min="-90" max="90" value="0" />
            <input id="Rzoom" type="range" min="1" max="15" value="3" /> <br />
            <ul id="markerlist" data-role="listview"></ul><br />
            <a data-role="button" data-icon="check" data-iconpos="left" id="btnSavePlaces">Zapisz miejsca</a>

        </div>
        <div data-role="header" style="height: 40px;" data-theme="b">
            <img id="menuButton" style="display: inline; position: absolute; top: 4px; left: 4px; width: 32px; height: 32px;" src="img\menu.png" alt="Menu" />
        </div>
        <div data-role="content">
            <div id="gmap"></div>

            <script>
                var listIndex = 0;
                var db = localStorage;
                var markers = [];

                $(document).ready(function () {

                    if (markers.length >= 1) {
                        if (!db.getItem("markers") == null) {
                            markers = JSON.parse(db.getItem("markers"));
                            listIndex = markers.length;
                        }
                    } else {
                        var btn = document.getElementById("btnSavePlaces");
                        btn.className = "ui-disabled";
                        console.log("Brak elementów w tablicy markers[]");
                    }

                    $("#gmap").width("100%").height(window.innerHeight - 75 + "px");
                    $("#gmap").gmap3({
                        map: {
                            options: {
                                latLng: [0.000, 0.000],
                                zoom: 3,
                                disableDefaultUI: true,
                                disableDoubleClickZoom: true
                            },
                            events: {
                                click: function (map,event) {
                                    //console.log(event);
                                    var map = $("#gmap").gmap3({ get: "map" });
                                    addMapMarker(event.latLng, map.getZoom());
                                }
                            }
                        }
                });

                $("#Rlon").change(function () {
                    //alert("zmiana")
                    var latV = parseInt($("#Rlat").val());
                    var lonV = parseInt($("#Rlon").val());
                    var map = $("#gmap").gmap3({ get: "map" });

                    map.setCenter(new google.maps.LatLng(latV, lonV));
                });

                $("#Rlat").change(function () {
                    var latV = parseInt($("#Rlat").val());
                    var lonV = parseInt($("#Rlon").val());
                    var map = $("#gmap").gmap3({ get: "map" });

                    map.setCenter(new google.maps.LatLng(latV, lonV));
                });

                $("#Rzoom").change(function () {
                    var zoomV = parseInt($("#Rzoom").val());
                    var map = $("#gmap").gmap3({ get: "map" });

                    map.setZoom(zoomV);

                });

                $("#menuButton").click(function () {
                    $("#optionsPanel").panel("open");
                });

                function addMapMarker(latLng, zoom) {
                    var map = $("#gmap").gmap3({get: "map"});
                    var marker = new google.maps.Marker({
                        position: latLng,
                        map: map,
                        options: {
                            zoom: zoom
                        }
                    })
                    console.log(latLng.lat() + " " + latLng.lng() + " " + zoom);
                    markers.push({ latLng: latLng, zoom: zoom });
                    db.setItem("markers", JSON.stringify(markers));
                    $("#markerlist").append("<li><a>Miejsce " + listIndex + "</a><a class=\"delete-marker\" data-icon=\"delete\"></a></li>");
                    $("#markerlist").listview("refresh");
                    var btn = document.getElementById("btnSavePlaces");
                    btn.className = "";
                    listIndex++;
                }
                
                $("#markerlist").on("click", "li", function() {
                    var index = $(this).index();
                    var map = $("#gmap").gmap3({ get: "map" });
                    map.setCenter(markers[index].latLng);
                    map.setZoom(markers[index].zoom);
                });


            });

            </script>
        </div>
        <div data-role="footer" data-position="fixed">
        </div>
    </div>


</body>
</html>
